Changes from master to rewrite:

